# Data Model: Fix Consultation API Endpoint

**Feature**: 005-fix-consultation-api
**Date**: 2025-11-17
**Phase**: Phase 1 Design

## Overview

This feature is a bug fix for the consultation form submission API. The database schema (`leads` table) already exists and is documented in `specs/002-home-page/data-model.md`. This document focuses on the API input/output schemas and data transformations.

---

## Database Schema Reference

**Full schema documentation**: [`specs/002-home-page/data-model.md`](../002-home-page/data-model.md)

### `leads` Table (Existing - No Changes)

```sql
CREATE TABLE leads (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(255) NOT NULL,
  phone VARCHAR(50) NOT NULL,
  telegram VARCHAR(100),
  email VARCHAR(255),
  source VARCHAR(50) NOT NULL DEFAULT 'home_page',
  user_agent TEXT,
  referrer TEXT,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);
```

**Constraints** (from existing schema):
- `phone`: Must contain minimum 7 digits, maximum 20 characters, accepts international formats with digits, spaces, hyphens, plus signs, and parentheses
- `telegram`: If provided, must match `^@[a-zA-Z0-9_]{3,32}$` (stored with @ prefix)
- `email`: If provided, must be valid email format
- `name`: 2-255 characters

---

## API Input Schema

### Request Body Validation (Zod)

```typescript
// api/submit-lead.ts

import { z } from 'zod';

const leadSchema = z.object({
  name: z.string()
    .min(2, 'Name must be at least 2 characters')
    .trim(),

  phone: z.string()
    .min(7, 'Phone number is required')
    .max(20, 'Phone number is too long')
    .trim()
    .refine(
      (val) => /^[\d\s\-\+\(\)]+$/.test(val) && /\d{7,}/.test(val.replace(/\D/g, '')),
      'Please enter a valid phone number'
    ),

  telegram: z.string()
    .regex(/^@?[a-zA-Z0-9_]{3,32}$/, 'Telegram handle must be 3-32 characters')
    .optional()
    .or(z.literal(''))
    .transform(val => {
      if (!val || val === '') return undefined;
      return val.startsWith('@') ? val : `@${val}`;
    }),

  email: z.string()
    .email('Invalid email address')
    .optional()
    .or(z.literal('')),
});

type LeadInput = z.infer<typeof leadSchema>;
```

### Input Examples

**Valid Input (All Fields)**:
```json
{
  "name": "Олена Коваленко",
  "phone": "+380501234567",
  "telegram": "olena_coach",
  "email": "olena@example.com"
}
```

**Valid Input (Required Only)**:
```json
{
  "name": "Іван Петренко",
  "phone": "+380671234567"
}
```

**Invalid Inputs**:
```json
// Missing required field
{ "name": "Test" }  // → 400: phone is required

// Invalid phone format
{ "name": "Test", "phone": "+38050" }  // → 400: invalid format

// Name too short
{ "name": "A", "phone": "+380501234567" }  // → 400: min 2 chars
```

---

## Data Transformations

### 1. Telegram Handle Normalization

**Input**: `telegram` field (with or without `@`)

**Transform**:
```typescript
// User types: "username123"
// API stores: "@username123"

// User types: "@username123"
// API stores: "@username123" (no change)
```

**Implementation**: Zod `.transform()` in validation schema

**Rationale**: Consistent database format while accepting user preference

### 2. Metadata Population

**Source**: HTTP Request Headers + Static Values

```typescript
const leadData = {
  ...validatedData,  // { name, phone, telegram?, email? }
  source: 'consultation_modal',  // Hardcoded for this form
  user_agent: request.headers.get('user-agent') || null,
  referrer: request.headers.get('referer') || null,
};
```

**Example Result**:
```typescript
{
  name: "Олена Коваленко",
  phone: "+380501234567",
  telegram: "@olena_coach",  // Normalized
  email: "olena@example.com",
  source: "consultation_modal",  // Auto-populated
  user_agent: "Mozilla/5.0...",  // Auto-populated
  referrer: "https://zhulova.com/",  // Auto-populated
}
```

### 3. Timestamp Handling

- `created_at`: Auto-generated by database (`DEFAULT NOW()`)
- `updated_at`: Auto-generated by database (trigger)

No manual timestamp handling required in API code.

---

## API Output Schema

### Success Response (HTTP 200)

```typescript
interface SuccessResponse {
  success: true;
  message: string;
  leadId: string;  // UUID from database
}
```

**Example**:
```json
{
  "success": true,
  "message": "Thank you! We'll contact you soon.",
  "leadId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
}
```

### Validation Error Response (HTTP 400)

```typescript
interface ValidationErrorResponse {
  success: false;
  error: string;
  details: Array<{
    path: string[];
    message: string;
  }>;
}
```

**Example**:
```json
{
  "success": false,
  "error": "Validation failed",
  "details": [
    {
      "path": ["phone"],
      "message": "Phone must be in format +380XXXXXXXXX"
    }
  ]
}
```

### Server Error Response (HTTP 500)

```typescript
interface ServerErrorResponse {
  success: false;
  error: string;
}
```

**Examples**:

```json
// Database insert failed
{
  "success": false,
  "error": "Failed to save your request"
}

// Email send failed (DB saved)
{
  "success": false,
  "error": "Your request was saved, but we couldn't send confirmation. We'll contact you soon."
}

// Unexpected error
{
  "success": false,
  "error": "An unexpected error occurred"
}
```

---

## Database Record Example

**After successful API call**, record in `leads` table:

```sql
SELECT * FROM leads WHERE id = 'a1b2c3d4-e5f6-7890-abcd-ef1234567890';
```

Result:
```
id                                   | a1b2c3d4-e5f6-7890-abcd-ef1234567890
name                                 | Олена Коваленко
phone                                | +380501234567
telegram                             | @olena_coach
email                                | olena@example.com
source                               | consultation_modal
user_agent                           | Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)...
referrer                             | https://zhulova.com/
created_at                           | 2025-11-17 19:30:45.123456+00
updated_at                           | 2025-11-17 19:30:45.123456+00
```

---

## Validation Rules Summary

| Field | Required | Format | Min | Max | Transform |
|-------|----------|--------|-----|-----|-----------|
| `name` | ✅ Yes | String | 2 chars | 255 chars | Trim whitespace |
| `phone` | ✅ Yes | International phone | 7 digits | 20 chars | Trim whitespace, validate digits |
| `telegram` | ❌ No | `@?[a-zA-Z0-9_]{3,32}` | 3 chars | 32 chars | Add `@` if missing |
| `email` | ❌ No | Email format | - | 255 chars | Empty string → `undefined` |
| `source` | Auto | - | - | - | Set to `consultation_modal` |
| `user_agent` | Auto | - | - | - | From HTTP header |
| `referrer` | Auto | - | - | - | From HTTP header |

---

## TypeScript Types

### Existing Types (Frontend)

```typescript
// src/types/consultationForm.ts (already exists)

export const consultationFormSchema = z.object({
  name: z.string().min(2).max(255).trim(),
  phone: z.string().regex(/^\+380\d{9}$/).trim(),
  telegram: z.string().regex(/^@?[a-zA-Z0-9_]{5,32}$/).optional().or(z.literal('')).transform(...),
  email: z.string().email().max(255).optional().or(z.literal('')).transform(...),
});

export type ConsultationFormData = z.infer<typeof consultationFormSchema>;
```

### New Types (Backend API)

```typescript
// api/submit-lead.ts (to be added)

// Same validation schema as frontend
const leadSchema = consultationFormSchema;  // Reuse from shared types

// Database record (with metadata)
interface LeadRecord {
  id: string;
  name: string;
  phone: string;
  telegram: string | null;
  email: string | null;
  source: string;
  user_agent: string | null;
  referrer: string | null;
  created_at: string;
  updated_at: string;
}

// API response types (as documented above)
type ApiResponse = SuccessResponse | ValidationErrorResponse | ServerErrorResponse;
```

---

## Data Flow Diagram

```
User Input (Form)
       ↓
  Frontend Validation (Zod)
       ↓
  POST /api/submit-lead
       ↓
  Backend Validation (Zod)
       ↓
  Normalize Telegram (@)
       ↓
  Add Metadata (source, user_agent, referrer)
       ↓
  Insert to Supabase (leads table)
       ↓
  Send Email (Resend)
       ↓
  Return Success Response
       ↓
  User sees "Дякуємо за вашу заявку!"
```

---

## Error Handling Flow

```
API Request
    ↓
Zod Validation
    ├─ FAIL → 400 ValidationErrorResponse
    └─ PASS
        ↓
    Database Insert
        ├─ FAIL → 500 ServerErrorResponse ("Failed to save")
        └─ SUCCESS
            ↓
        Email Send
            ├─ FAIL → 500 ServerErrorResponse ("Saved but no email")
            └─ SUCCESS
                ↓
            200 SuccessResponse
```

---

## Testing Data

### Test Cases

1. **Valid (All Fields)**:
   ```json
   { "name": "Test User", "phone": "+380501234567", "telegram": "testuser", "email": "test@example.com" }
   ```
   Expected: 200, database record created, email sent

2. **Valid (Required Only)**:
   ```json
   { "name": "Test User", "phone": "+380501234567" }
   ```
   Expected: 200, telegram/email = NULL

3. **Invalid Phone**:
   ```json
   { "name": "Test User", "phone": "+38050" }
   ```
   Expected: 400 validation error

4. **Telegram Without @**:
   ```json
   { "name": "Test User", "phone": "+380501234567", "telegram": "testuser" }
   ```
   Expected: 200, telegram stored as "@testuser"

5. **Telegram With @**:
   ```json
   { "name": "Test User", "phone": "+380501234567", "telegram": "@testuser" }
   ```
   Expected: 200, telegram stored as "@testuser" (unchanged)

---

## Summary

- **Database Schema**: Existing, no changes required
- **API Input**: 4 fields (2 required, 2 optional)
- **Transformations**: Telegram normalization + metadata population
- **API Output**: 3 response types (success, validation error, server error)
- **Type Safety**: Zod schemas with TypeScript inference
- **Testing**: Documented test cases with expected outcomes

**Status**: ✅ Data model complete, ready for API contract generation

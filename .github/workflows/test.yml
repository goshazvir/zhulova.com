name: Test

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Lint (ESLint)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  unit-tests:
    name: Unit Tests (Vitest)
    runs-on: ubuntu-latest
    needs: lint  # Only run if lint passes (fast-fail pattern)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:run

      - name: Generate coverage report
        if: always()
        run: npm run test:coverage

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 14
          if-no-files-found: warn

      - name: Comment coverage summary on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Try to read coverage summary
            let coverageText = 'ðŸ“Š Coverage report generated';
            try {
              if (fs.existsSync('coverage/coverage-summary.json')) {
                const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
                const total = coverage.total;

                coverageText = `ðŸ“Š **Test Coverage Summary**

                | Metric | Coverage |
                |--------|----------|
                | Statements | ${total.statements.pct}% |
                | Branches | ${total.branches.pct}% |
                | Functions | ${total.functions.pct}% |
                | Lines | ${total.lines.pct}% |

                [View full report in artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
              }
            } catch (e) {
              console.log('Coverage summary not found, using default message');
            }

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Test Coverage Summary')
            );

            const body = `## âœ… Unit Tests Completed

            ${coverageText}

            **Status**: ${{ job.status }}
            **Run**: [View logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: unit-tests  # Only run if unit tests pass (fast-fail pattern)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers (Chromium only for CI)
        run: npx playwright install --with-deps chromium

      - name: Build project
        run: npm run build
        env:
          # Use test environment variables
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          PUBLIC_SITE_URL: http://localhost:4321

      - name: Run Playwright tests
        run: npx playwright test --project=chromium
        env:
          CI: true

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload test screenshots and traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Comment E2E results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let testResults = 'ðŸ§ª E2E tests completed';
            try {
              // Try to parse test results from Playwright JSON reporter
              if (fs.existsSync('test-results/.last-run.json')) {
                const results = JSON.parse(fs.readFileSync('test-results/.last-run.json', 'utf8'));
                const { passed, failed, flaky, skipped } = results.stats || {};

                testResults = `ðŸ§ª **E2E Test Results**

                | Status | Count |
                |--------|-------|
                | âœ… Passed | ${passed || 0} |
                | âŒ Failed | ${failed || 0} |
                | âš ï¸ Flaky | ${flaky || 0} |
                | â­ï¸ Skipped | ${skipped || 0} |

                [View full report in artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
              }
            } catch (e) {
              console.log('Test results not found, using default message');
            }

            const statusIcon = '${{ job.status }}' === 'success' ? 'âœ…' : 'âŒ';
            const failureNote = '${{ job.status }}' === 'failure' ? '\n\nâš ï¸ **Screenshots and traces** available in artifacts (7 days retention)' : '';

            const body = `## ${statusIcon} E2E Tests Completed

            ${testResults}

            **Status**: ${{ job.status }}
            **Browser**: Chromium (Desktop Chrome)
            **Run**: [View logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})${failureNote}`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('E2E Test Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

  # Summary job (always runs, shows overall status)
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "E2E Tests: ${{ needs.e2e-tests.result }}"

          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "::error::Lint failed"
            exit 1
          fi

          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "::error::Unit tests failed"
            exit 1
          fi

          if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
            echo "::error::E2E tests failed"
            exit 1
          fi

          echo "âœ… All tests passed!"
